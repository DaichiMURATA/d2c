name: Auto-Update PR Description with Preview URLs

on:
  pull_request:
    types: [opened, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Preview URLs
        id: generate-urls
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"
          
          # AEM.live Preview URLã‚’ç”Ÿæˆ
          SOURCE_URL="https://${BRANCH_NAME}--d2c--daichimurata.aem.live/"
          TARGET_URL="https://${TARGET_BRANCH}--d2c--daichimurata.aem.live/"
          
          echo "source_url=${SOURCE_URL}" >> $GITHUB_OUTPUT
          echo "target_url=${TARGET_URL}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "target_branch=${TARGET_BRANCH}" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Generated Preview URLs:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Source Branch: ${BRANCH_NAME}"
          echo "Source URL: ${SOURCE_URL}"
          echo "Target Branch: ${TARGET_BRANCH}"
          echo "Target URL: ${TARGET_URL}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Get current PR body
        id: get-pr-body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const currentBody = pr.body || '';
            core.setOutput('current_body', currentBody);

      - name: Update PR Description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceUrl = '${{ steps.generate-urls.outputs.source_url }}';
            const targetUrl = '${{ steps.generate-urls.outputs.target_url }}';
            const branchName = '${{ steps.generate-urls.outputs.branch_name }}';
            const targetBranch = '${{ steps.generate-urls.outputs.target_branch }}';
            const currentBody = `${{ steps.get-pr-body.outputs.current_body }}`;
            
            // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’å®Ÿéš›ã®URLã«ç½®ãæ›ãˆ
            let newBody = currentBody
              .replace(/\{\{BRANCH_NAME\}\}/g, branchName)
              .replace(/https:\/\/\{\{BRANCH_NAME\}\}--d2c--daichimurata\.aem\.live\//g, sourceUrl);
            
            // ã‚‚ã—ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒãªã„å ´åˆï¼ˆæ‰‹å‹•ã§ä½œæˆã•ã‚ŒãŸPRï¼‰ã€Preview URLã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            if (!newBody.includes('Preview URLs') && !newBody.includes('aem.live')) {
              const previewSection = `
            
            ## ğŸ”— Preview URLs
            
            **Source Branch Preview (${branchName}):**
            - ${sourceUrl}
            
            **Target Branch Preview (${targetBranch}):**
            - ${targetUrl}
            `;
              newBody = newBody + previewSection;
            }
            
            // PR Descriptionã‚’æ›´æ–°
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: newBody
            });
            
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('âœ… PR Description updated with Preview URLs');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log(`Source: ${sourceUrl}`);
            console.log(`Target: ${targetUrl}`);
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

      - name: Add Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const sourceUrl = '${{ steps.generate-urls.outputs.source_url }}';
            const targetUrl = '${{ steps.generate-urls.outputs.target_url }}';
            const branchName = '${{ steps.generate-urls.outputs.branch_name }}';
            const targetBranch = '${{ steps.generate-urls.outputs.target_branch }}';
            
            const comment = `## ğŸ”— Preview URLs

            Your changes have been deployed to AEM.live!

            | Branch | Preview URL |
            |--------|-------------|
            | **${branchName}** (Source) | ${sourceUrl} |
            | **${targetBranch}** (Target) | ${targetUrl} |

            ### ğŸš€ Quick Links
            - [View Source Preview](${sourceUrl})
            - [View Target Preview](${targetUrl})

            ---
            *Preview URLs are automatically generated from the branch name.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
            
            console.log('âœ… Preview URLs comment added to PR');
